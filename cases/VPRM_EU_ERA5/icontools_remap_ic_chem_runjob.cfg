#!/usr/bin/env bash
#SBATCH --job-name="{cfg.casename}_{cfg.inidate_yyyymmddhh}_{cfg.forecasttime}"
#SBATCH --account={cfg.compute_account}
#SBATCH --chdir={cfg.icon_work}
#SBATCH --partition=normal
#SBATCH --time={cfg.icon_walltime} 
#SBATCH --constraint={cfg.constraint}
#SBATCH --nodes=1
#SBATCH --ntasks-per-core=1
#SBATCH --ntasks-per-node={cfg.ntasks_per_node}
#SBATCH --cpus-per-task=1
#SBATCH --output={logfile}
#SBATCH --open-mode=append
ulimit -s unlimited
module load cray-netcdf
module load CDO
module load NCO
module load gcc/9.3.0

set -x

export ECCODES_DEFINITION_PATH=/store/empa/em05/eccodes_definitions/definitions.edzw-2.12.5-2
export ECCODES_DEFINITION_PATH=$ECCODES_DEFINITION_PATH:/store/empa/em05/easybuild.backup/software/ecCodes/2.12.5-CrayGNU-20.08/share/eccodes/definitions
export ECCODES_DEFINITION_PATH=$ECCODES_DEFINITION_PATH:/project/g110/spack-install/daint/eccodes/2.19.0/pgi/6skdmw5lsn6mjv4esxkyalf6xogllshi/share/eccodes/definitions/
echo $ECCODES_DEFINITION_PATH

export PMI_MMAP_SYNC_WAIT_TIME=300
export OMP_NUM_THREADS=1
export OMP_SCHEDULE="static"
export OMP_DYNAMIC="false"
export RLIMIT_CORE=0
export ATP_MAX_CORES=0

#-----------------------------------------------------------------------------
# Remap inital data onto local (limited-area) grid
#-----------------------------------------------------------------------------

cat > NAMELIST_ICONREMAP_FIELDS << EOF
!
&parameter
 name       = "ch4"
 out_name     = "CH4_BG"
 param_out     = 255
/
&parameter
 name       = "co2"
 out_name     = "CO2"
 param_out     = 254
/
&parameter ! temperature
 name       = "T"
 out_name     = "T"
 param_out    = 130
/
&parameter ! specific humidity
 name       = "QV"
 out_name     = "Q"
 param_out    = 133
/
&parameter  ! surface pressure
name      = "lnsp"
out_name     = "LNPS"
param_out    = 152
/
EOF


#-----------------------------------------------------------------------------
# loop over file list:
#cdo -s selgrid,2 {cfg.dynamics_grid_filename} cdogrid_ic.nc

datafilename={cfg.input_root_chem}/{cfg.chem_prefix}{cfg.inidate_yyyymmdd_hh}{cfg.chem_suffix}
datafile="${{datafilename##*/}}"  # get filename without path
outdatafile=${{datafile%.*}}      # get filename without suffix


cdo -t ecmwf -f nc copy {cfg.input_root_chem}/${{datafile}} tmp1.nc
cdo setpartabn,NAMELIST_ICONREMAP_FIELDS,convert tmp1.nc tmp2.nc


# create file with ICON grid information for CDO
cdo -s selgrid,2 {cfg.dynamics_grid_filename} triangular-grid.nc

# remap land area only variables (ocean points are assumed to be undefined in the input data)
#cdo setmisstodis -selname,SMIL1,SMIL2,SMIL3,SMIL4,STL1,STL2,STL3,STL4,W_SNOW,T_SNOW tmp2.nc tmpl1.nc
cdo remapdis,triangular-grid.nc tmp2.nc {cfg.icon_input_icbc}/${{outdatafile}}.nc
# cdo -s div tmpl2.nc output_land_area.nc tmp_output_l.nc
rm tmp*.nc


#-----------------------------------------------------------------------------
# clean-up

rm -f ncstorage.tmp*
rm -f nml.log NAMELIST_ICONREMAP_FIELDS
#-----------------------------------------------------------------------------
exit
